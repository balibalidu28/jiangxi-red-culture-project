<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>红色故事详情 - 江西红色文化信息网</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 使用与首页相同的CSS -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/story/detail.css">
</head>
<body>
<!-- 导航栏 -->
<nav class="navbar navbar-expand-lg navbar-dark navbar-red sticky-top">
    <div class="container">
        <!-- 修改点：跳转回首页使用相对路径 ../ -->
        <a class="navbar-brand" href="../index.html">
            <i class="fas fa-landmark me-2"></i>
            <strong>江西红色文化</strong>
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <!-- 首页链接 -->
                <li class="nav-item">
                    <a class="nav-link" href="../index.html">
                        <i class="fas fa-home me-1"></i> 首页
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="../hero/list.html">
                        <i class="fas fa-user-shield me-1"></i> 红色英雄
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link active" href="../encyclopedia/list.html">
                        <i class="fas fa-book me-1"></i> 党史大百科
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../RedScenicSpot/list.html">
                        <i class="fas fa-map-marked-alt me-1"></i> 红色圣地
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../story/list.html">
                        <i class="fas fa-book-open me-1"></i> 红色故事
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../explore/list.html">
                        <i class="fas fa-hiking me-1"></i> 红色寻访
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- 面包屑导航 -->
<div class="container-fluid py-3" style="background: linear-gradient(135deg, #fff8e1, #ffebee);">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="../index.html" style="text-decoration: none; color: var(--red-primary);">首页</a></li>
                <li class="breadcrumb-item"><a href="../story/list.html">红色故事</a></li>
                <li class="breadcrumb-item active" aria-current="page" id="breadcrumbTitle">故事详情</li>
            </ol>
        </nav>
    </div>
</div>

<!-- 故事头部 -->
<div class="story-header">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="story-title" id="storyTitle">正在加载...</h1>

                <!-- 故事元信息 -->
                <div class="story-meta">
                    <div class="meta-item" id="heroInfo" style="display: none;">
                        <i class="fas fa-user-tie"></i>
                        <span class="meta-label">英雄人物：</span>
                        <span class="meta-value" id="heroName">多位革命先烈</span>
                    </div>

                    <div class="meta-item" id="timeInfo" style="display: none;">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="meta-label">发生时间：</span>
                        <span class="meta-value" id="storyTime">1927年</span>
                    </div>

                    <div class="meta-item" id="locationInfo" style="display: none;">
                        <i class="fas fa-map-marker-alt"></i>
                        <span class="meta-label">发生地点：</span>
                        <span class="meta-value" id="storyLocation">江西井冈山</span>
                    </div>

                    <div class="meta-item" id="publishInfo">
                        <i class="fas fa-clock"></i>
                        <span class="meta-label">发布时间：</span>
                        <span class="meta-value" id="publishTime">2024年3月15日</span>
                    </div>

                    <div class="meta-item" id="sourceInfo" style="display: none;">
                        <i class="fas fa-bookmark"></i>
                        <span class="meta-label">来源：</span>
                        <span class="meta-value" id="storySource">《江西革命故事集》</span>
                    </div>
                </div>

                <!-- 故事简介 -->
                <div id="summarySection" class="alert alert-danger" role="alert" style="display: none;">
                    <h5><i class="fas fa-quote-left me-2"></i>故事简介</h5>
                    <p class="mb-0" id="storySummary">这是一段感人至深的革命故事...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 主内容区域 - 左侧占据全部宽度 -->
<div class="container">
    <div class="row">
        <!-- 内容区域现在占据整个宽度 -->
        <div class="col-12">
            <!-- 返回列表链接 -->
            <div class="back-to-list">
                <a href="../story/list.html" class="text-danger">
                    <i class="fas fa-arrow-left me-2"></i>返回故事列表
                </a>
            </div>

            <!-- 加载状态 -->
            <div id="loadingState" class="text-center py-5">
                <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-3">正在加载故事详情...</p>
            </div>

            <!-- 错误状态 -->
            <div id="errorState" class="text-center py-5" style="display: none;">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h4>加载失败</h4>
                <p id="errorMessage">无法加载故事详情，请稍后重试。</p>
                <a href="../story/list.html" class="btn btn-danger">
                    <i class="fas fa-arrow-left me-2"></i>返回故事列表
                </a>
            </div>

            <!-- 故事内容区域 -->
            <div id="contentArea" style="display: none;">
                <!-- 故事封面图 -->
                <div class="text-center mb-4">
                    <img id="storyImage"
                         src="https://placehold.co/800x450/8B0000/FFFFFF?text=红色故事"
                         alt="故事封面"
                         class="img-fluid rounded shadow-lg"
                         style="max-height: 500px; width: auto;">
                </div>

                <!-- 故事内容 -->
                <div class="card card-red mb-4">
                    <div class="card-body">
                        <div class="story-content" id="storyContent">
                            <!-- 这里显示故事内容 -->
                        </div>

                        <!-- 统计数据 -->
                        <div class="story-stats">
                            <div class="story-stat">
                                <i class="fas fa-calendar"></i>
                                <span>最后更新：<span id="updateTime">2024-03-15</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 分享和操作按钮 -->
                <div class="story-actions">
                    <div class="text-center mb-3">
                        <h5 class="text-danger">
                            <i class="fas fa-share-alt me-2"></i>分享这个故事
                        </h5>
                        <p class="text-muted">将这份红色记忆传递给更多人</p>
                    </div>
                    <div class="action-buttons">
                        <a href="#" class="share-button wechat" onclick="shareToWechat()">
                            <i class="fab fa-weixin"></i> 微信
                        </a>
                        <a href="#" class="share-button weibo" onclick="shareToWeibo()">
                            <i class="fab fa-weibo"></i> 微博
                        </a>
                        <a href="#" class="share-button qq" onclick="shareToQQ()">
                            <i class="fab fa-qq"></i> QQ
                        </a>
                        <a href="#" class="share-button print" onclick="window.print()">
                            <i class="fas fa-print"></i> 打印
                        </a>
                    </div>
                </div>

                <!-- 相关故事 -->
                <div id="relatedStoriesSection" class="related-stories" style="display: none;">
                    <h4 class="related-title">
                        <i class="fas fa-book-open me-2"></i>相关故事
                    </h4>
                    <div id="relatedStoriesList">
                        <!-- 相关故事将在这里动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 完整的页脚 -->
<footer class="footer-red py-5 mt-5">
    <div class="container">
        <div class="row">
            <div class="col-md-4 mb-4">
                <h4 class="mb-4" style="color: white;">
                    <i class="fas fa-landmark me-2"></i>
                    <strong>江西红色文化信息网</strong>
                </h4>
                <p style="color: rgba(255,255,255,0.8);">
                    聆听革命故事，传承红色基因，弘扬革命精神。我们致力于传播江西丰富的红色文化资源，让革命精神代代相传。
                </p>
                <div class="mt-3">
                    <a href="#" class="text-white me-3"><i class="fab fa-weixin fa-lg"></i></a>
                    <a href="#" class="text-white me-3"><i class="fab fa-weibo fa-lg"></i></a>
                    <a href="#" class="text-white me-3"><i class="fab fa-qq fa-lg"></i></a>
                    <a href="#" class="text-white"><i class="fas fa-envelope fa-lg"></i></a>
                </div>
            </div>

            <div class="col-md-4 mb-4">
                <h5 class="mb-4" style="color: white;">快速链接</h5>
                <div class="footer-links">
                    <p><a href="/jiangxi-red-culture-project/JXRedCultureDisplay/templates/hero/list.html">红色英雄</a></p>
                    <p><a href="/jiangxi-red-culture-project/JXRedCultureDisplay/templates/encyclopedia/list.html">党史大百科</a></p>
                    <p><a href="/jiangxi-red-culture-project/JXRedCultureDisplay/templates/RedScenicSpot/list.html">红色圣地</a></p>
                    <p><a href="/jiangxi-red-culture-project/JXRedCultureDisplay/templates/story/list.html">红色故事</a></p>
                    <p><a href="/jiangxi-red-culture-project/JXRedCultureDisplay/templates/explore/list.html">红色寻访</a></p>
                </div>
            </div>

            <div class="col-md-4 mb-4">
                <h5 class="mb-4" style="color: white;">联系我们</h5>
                <p style="color: rgba(255,255,255,0.8);">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    江西省南昌市红谷滩区赣江中大道688号
                </p>
                <p style="color: rgba(255,255,255,0.8);">
                    <i class="fas fa-phone me-2"></i>
                    服务热线：0791-12345678
                </p>
                <p style="color: rgba(255,255,255,0.8);">
                    <i class="fas fa-envelope me-2"></i>
                    电子邮箱：contact@jxredculture.com
                </p>
                <p style="color: rgba(255,255,255,0.8);">
                    <i class="fas fa-clock me-2"></i>
                    工作时间：周一至周五 9:00-17:00
                </p>
            </div>
        </div>

        <hr style="background-color: rgba(255,255,255,0.2); margin: 2rem 0;">

        <div class="row">
            <div class="col-md-6">
                <p class="mb-0" style="color: rgba(255,255,255,0.7);">
                    <i class="fas fa-copyright me-1"></i>
                    2024 江西红色文化信息网. 保留所有权利.
                </p>
                <p class="mb-0 mt-2" style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                    赣ICP备12345678号 | 赣公网安备 36010002000001号
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <p class="mb-0">
                    <a href="#" class="text-light text-decoration-none me-3">关于我们</a>
                    <a href="#" class="text-light text-decoration-none me-3">隐私政策</a>
                    <a href="#" class="text-light text-decoration-none me-3">使用条款</a>
                    <a href="#" class="text-light text-decoration-none">网站地图</a>
                </p>
                <p class="mb-0 mt-2" style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                    技术支持：江西红色文化研究院 | 版本：V2.1.0
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 从URL获取故事ID
    function getStoryIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
    }

    // 格式化日期
    function formatDate(dateString) {
        if (!dateString) return '';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        } catch (e) {
            return dateString;
        }
    }

    // 分享功能
    function shareToWechat() {
        const storyTitle = document.getElementById('storyTitle').textContent;
        alert(`请使用微信扫描二维码分享"${storyTitle}"`);
    }

    function shareToWeibo() {
        const url = encodeURIComponent(window.location.href);
        const title = encodeURIComponent(document.title);
        window.open(`http://service.weibo.com/share/share.php?url=${url}&title=${title}`, '_blank');
    }

    function shareToQQ() {
        const url = encodeURIComponent(window.location.href);
        const title = encodeURIComponent(document.title);
        window.open(`http://connect.qq.com/widget/shareqq/index.html?url=${url}&title=${title}`, '_blank');
    }

    // 通用函数：处理图片URL
    function processImageUrl(imageUrl) {
        if (!imageUrl) {
            return 'https://placehold.co/800x450/8B0000/FFFFFF?text=红色故事';
        }

        // 如果已经是完整URL，直接返回
        if (imageUrl.startsWith('http')) {
            return imageUrl;
        }

        // 添加服务器地址
        const baseUrl = 'http://localhost:8080';
        if (imageUrl.startsWith('/')) {
            return baseUrl + imageUrl;
        } else {
            return baseUrl + '/' + imageUrl;
        }
    }

    // 加载故事详情
    async function loadStoryDetail(storyId) {
        try {
            // 显示加载状态
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('contentArea').style.display = 'none';

            // 调用后端API获取故事详情
            const response = await fetch(`http://localhost:8080/stories/api/${storyId}`);

            if (!response.ok) {
                throw new Error(`HTTP错误! 状态: ${response.status}`);
            }

            const story = await response.json();

            // 处理图片URL
            if (story.imageUrl) {
                story.imageUrl = processImageUrl(story.imageUrl);
            }

            // 更新页面内容
            updateStoryContent(story);

            // 获取相关故事
            await loadRelatedStories(storyId, story.heroName);

        } catch (error) {
            console.error('加载故事详情失败:', error);
            showError('无法加载故事详情：' + error.message);
        } finally {
            document.getElementById('loadingState').style.display = 'none';
        }
    }

    // 更新故事内容
    function updateStoryContent(story) {
        // 更新标题
        document.title = `${story.title} - 红色故事`;
        document.getElementById('storyTitle').textContent = story.title;
        document.getElementById('breadcrumbTitle').textContent = story.title;

        // 更新元信息
        if (story.heroName) {
            document.getElementById('heroInfo').style.display = 'block';
            document.getElementById('heroName').textContent = story.heroName;
        }

        if (story.storyTime) {
            document.getElementById('timeInfo').style.display = 'block';
            document.getElementById('storyTime').textContent = story.storyTime;
        }

        if (story.location) {
            document.getElementById('locationInfo').style.display = 'block';
            document.getElementById('storyLocation').textContent = story.location;
        }

        if (story.createdAt) {
            document.getElementById('publishTime').textContent = formatDate(story.createdAt);
            // publishDate不再需要，因为对应的HTML元素已删除
        }

        if (story.updatedAt) {
            document.getElementById('updateTime').textContent = story.updatedAt.split('T')[0];
        }

        if (story.source) {
            document.getElementById('sourceInfo').style.display = 'block';
            document.getElementById('storySource').textContent = story.source;
        }

        // 更新简介
        if (story.summary) {
            document.getElementById('summarySection').style.display = 'block';
            document.getElementById('storySummary').textContent = story.summary;
        }

        // 更新图片
        if (story.imageUrl) {
            document.getElementById('storyImage').src = story.imageUrl;
            document.getElementById('storyImage').alt = story.title;
        }

        // 更新内容
        if (story.content) {
            document.getElementById('storyContent').innerHTML = story.content;
        }

        // 显示内容区域
        document.getElementById('contentArea').style.display = 'block';
    }

    // 加载相关故事
    async function loadRelatedStories(currentStoryId, heroName) {
        try {
            let apiUrl = 'http://localhost:8080/stories/api?page=0&size=4';
            if (heroName) {
                apiUrl += `&kw=${encodeURIComponent(heroName)}`;
            }

            const response = await fetch(apiUrl);
            const data = await response.json();

            if (data.content && data.content.length > 0) {
                // 过滤掉当前故事
                const relatedStories = data.content.filter(story => story.id != currentStoryId);

                if (relatedStories.length > 0) {
                    // 处理相关故事的图片URL
                    relatedStories.forEach(story => {
                        if (story.imageUrl) {
                            story.imageUrl = processImageUrl(story.imageUrl);
                        }
                    });

                    displayRelatedStories(relatedStories);
                    document.getElementById('relatedStoriesSection').style.display = 'block';
                }
            }
        } catch (error) {
            console.error('加载相关故事失败:', error);
        }
    }

    // 显示相关故事
    function displayRelatedStories(stories) {
        const container = document.getElementById('relatedStoriesList');
        container.innerHTML = '';

        stories.forEach(story => {
            const storyCard = document.createElement('div');
            storyCard.className = 'related-story-card';

            const storyDate = story.createdAt ? story.createdAt.split('T')[0] : '';

            storyCard.innerHTML = `
                <div class="related-story-image">
                    <img src="${story.imageUrl || 'https://placehold.co/100x80/8B0000/FFFFFF?text=故事'}"
                         alt="${story.title}"
                         style="width: 100px; height: 80px; object-fit: cover; border-radius: 5px; float: left; margin-right: 15px;">
                </div>
                <h5 class="related-story-title">${story.title}</h5>
                <div class="related-story-meta">
                    ${story.heroName ? `
                        <span><i class="fas fa-user-tie me-1"></i>${story.heroName}</span>
                    ` : ''}
                    ${story.location ? `
                        <span class="ms-3"><i class="fas fa-map-marker-alt me-1"></i>${story.location}</span>
                    ` : ''}
                    ${storyDate ? `
                        <span class="ms-3"><i class="fas fa-calendar me-1"></i>${storyDate}</span>
                    ` : ''}
                </div>
                <p class="related-story-summary">${story.summary || (story.content ? story.content.substring(0, 120) + '...' : '')}</p>
                <div style="clear: both;"></div>
                <a href="http://localhost:63342/jiangxi-red-culture-project/JXRedCultureDisplay/templates/story/detail.html?id=${story.id}" class="btn btn-sm btn-danger mt-2">
                    阅读详情 <i class="fas fa-arrow-right ms-1"></i>
                </a>
            `;

            container.appendChild(storyCard);
        });
    }

    // 显示错误信息
    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorState').style.display = 'block';
    }

    // 页面加载完成后的操作
    document.addEventListener('DOMContentLoaded', function() {
        const storyId = getStoryIdFromUrl();

        if (!storyId) {
            showError('未找到故事ID，请从故事列表页面进入');
            return;
        }

        loadStoryDetail(storyId);

        // 添加相关故事卡片的悬停效果
        setTimeout(() => {
            const relatedCards = document.querySelectorAll('.related-story-card');
            relatedCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateX(5px)';
                    this.style.transition = 'transform 0.3s ease';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateX(0)';
                });
            });
        }, 1000);

        // 打印样式优化
        const printButton = document.querySelector('[onclick="window.print()"]');
        if (printButton) {
            printButton.addEventListener('click', function(e) {
                setTimeout(() => {
                    const printStyle = document.createElement('style');
                    printStyle.textContent = `
                        @media print {
                            nav, footer, .story-actions, .back-to-list, .related-stories {
                                display: none !important;
                            }
                            .container {
                                max-width: 100% !important;
                            }
                            .story-content {
                                font-size: 16px !important;
                                line-height: 1.6 !important;
                            }
                            .story-header {
                                padding: 1rem 0 !important;
                            }
                            .story-title {
                                font-size: 24px !important;
                            }
                        }
                    `;
                    document.head.appendChild(printStyle);
                }, 100);
            });
        }
    });
</script>
</body>
</html>